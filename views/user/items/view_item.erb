<div class="container mt-5">
    <div class="row mb-3">
        <div class="col-12 col-md-9">
            <div class="card mb-3">
                <div class="row g-0">
                    <div class="col-md-6">
                        <% if @item['item_photo'] && !@item['item_photo'].empty? %>
                            <img src="/uploads/items/<%= @item['item_photo'] %>" class="img-fluid rounded-start" alt="<%= @item['item_name'] %>">
                        <% else %>
                            <img src="/img/question.png" class="img-fluid rounded-start" alt="Default Item">
                        <% end %>
                    </div>
                    <div class="col-md-6">
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <h4><b><%= @item['item_name'] %></b></h4>    
                                    </p>
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <%= @item['item_description'] %>
                                    </p>
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <strong>Price:</strong> <%= rupiah_currency(@item['item_price']) %>
                                    </p>
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <strong>Stock:</strong> <%= @item['item_stock'] %>
                                    </p>   
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <strong>Category:</strong> <%= @item['item_category'] %>
                                    </p>
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <strong>Unit:</strong> <%= @item['item_unit'] %>
                                    </p>
                                </li>
                                <% if current_user['access'].to_i == 1 %>
                                    <a href="/account" class="btn btn-primary float-start">Back</a>
                                <% elsif current_user['access'].to_i ==2 %>
                                    <a href="/seller" class="btn btn-primary float-start">Back</a>
                                <% end %>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="card">
                <div class="card-body">
                    <p><b>Atur Jumlah dan Catatan</b></p>

                    <!-- Buy Form -->
                    <form action="/add_to_basket/<%= @item['item_id'] %>" method="POST">
                        <!-- Input Amount -->
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Total</label>
                            <div class="input-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="decreaseQty()">-</button>
                                <input type="text" class="form-control text-center" id="quantity" name="quantity" value="1" min="1" max="<%= @item['item_stock'] %>">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="increaseQty()">+</button>
                            </div>
                        </div>

                        <!-- Input Notes -->
                        <div class="mb-3">
                            <label for="note" class="form-label">Notes</label>
                            <textarea class="form-control" name="note" id="note" rows="3" ></textarea>
                        </div>

                        <!-- Total Price -->
                        <p>
                            <b>SubTotal : </b> <span id="totalPrice"><%= rupiah_currency(@item['item_price']) %></span>
                        </p>

                        <div class="d-grid gap-2 mb-2">
                            <button type="submit" name="action" value="cart" class="btn btn-success">+ Keranjang</button>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="buy" class="btn btn-outline-success">Beli Langsung</button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const price = <%= @item['item_price'].to_i %>;
    const stock = <%= @item['item_stock'].to_i %>;
    const qtyInput = document.getElementById('quantity');
    const totalPrice = document.getElementById('totalPrice'); // match with HTML

    function updateTotal() {
        let qty = parseInt(qtyInput.value) || 1;
        if (qty < 1) qty = 1;
        if (qty > stock) qty = stock;
        qtyInput.value = qty;


        totalPrice.innerText = new Intl.NumberFormat('id-ID', 
        { 
            style: 'currency', 
            currency: 'IDR' 
        }).format(price * qty);
    }

    function decreaseQty() {
        qtyInput.value = Math.max(1, parseInt(qtyInput.value) - 1);
        updateTotal();
    }

    function increaseQty() {
        qtyInput.value = Math.min(stock, parseInt(qtyInput.value) + 1);
        updateTotal();
    }

    qtyInput.addEventListener('input', updateTotal);

    // Initialize subtotal on page load 
    updateTotal();

</script>