<div class="container mt-5">
    <div class="row mb-3">
        <div class="col-12">
            <% if flash[:success] %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong><%= flash[:success] %></strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% flash[:success] = nil %>
            <% end %>
        </div>
        <div class="col-12">
            <% if flash[:notice] %>
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    <strong><%= flash[:notice] %></strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% flash[:notice] = nil %>
            <% end %>
        </div>
        <div class="col-12 col-md-9">
            <div class="card mb-3">
                <div class="row g-0">
                    <div class="col-md-6">
                        <% if @item['item_photo'] && !@item['item_photo'].empty? %>
                            <img src="/uploads/items/<%= @item['item_photo'] %>" class="img-fluid rounded-start" alt="<%= @item['item_name'] %>">
                        <% else %>
                            <img src="/img/question.png" class="img-fluid rounded-start" alt="Default Item">
                        <% end %>
                    </div>
                    <div class="col-md-6">
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <h4><b><%= @item['item_name'] %></b></h4>    
                                    </p>
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <%= @item['item_description'] %>
                                    </p>
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <strong>Price:</strong> <%= rupiah_currency(@item['item_price']) %>
                                    </p>
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <strong>Stock:</strong> <%= @item['item_stock'] %>
                                    </p>   
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <strong>Category:</strong> <%= @item['item_category'] %>
                                    </p>
                                </li>
                                <li class="list-group-item">
                                    <p class="card-text">
                                        <strong>Unit:</strong> <%= @item['item_unit'] %>
                                    </p>
                                </li>
                                <% if current_user['access'].to_i == 1 %>
                                    <a href="/account" class="btn btn-primary float-start">Back</a>
                                <% elsif current_user['access'].to_i == 2 %>
                                    <a href="/account" class="btn btn-primary float-start">Back</a>
                                <% end %>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="card">
                <div class="card-body">
                    <p><b>Atur Jumlah dan Catatan</b></p>

                    <!-- Buy Form -->
                    <form action="/add_to_transaction/<%= @item['item_id'] %>" method="POST">
                        <!-- Input Amount -->
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Total</label>
                            <div class="input-group">
                                <button id="decreaseBtn" type="button" class="btn btn-sm btn-outline-secondary" onclick="decreaseQty()">-</button>
                                <input type="text" class="form-control text-center" id="quantity" name="quantity" value="1">
                                <button id="increaseBtn" type="button" class="btn btn-sm btn-outline-secondary" onclick="increaseQty()">+</button>
                            </div>
                        </div>

                        <div id="zero" class="text-danger fw-bold mb-2" style="display: none;">
                            <small>Minimum Order is 1</small>
                        </div>

                        <!-- Input Notes -->
                        <div class="mb-3">
                            <label for="note" class="form-label">Notes</label>
                            <textarea class="form-control" name="note" id="note" rows="3" ></textarea>
                        </div>

                        <!-- Total Price -->
                        <p>
                            <b>SubTotal : </b> <span id="totalPrice"><%= rupiah_currency(@item['item_price']) %></span>
                        </p>

                        <div id="stockWarning" class="text-danger fw-bold mb-2" style="display: none;">
                            Maximum stock capacity has been reached
                        </div>

                        <div class="d-grid gap-2 mb-2">
                            <button type="submit" name="action" value="cart" class="btn btn-success">+ Keranjang</button>
                            <button type="submit" name="action" value="buy" class="btn btn-outline-success">Beli Langsung</button>
                        </div>
                    </form>

                    <hr>

                    <!-- Additional Buttons -->
                    <div class="d-flex justify-content-around">
                        <a href="/chat_seller/<%= @item['store_id'] %>" class="text-dark text-decoration-none text-center">
                            <img src="/img/icons/chat-left-text.svg" class="mb-1" alt="Chat">
                            <small>Chat</small>
                        </a>
                        <form action="/add_to_wishlist/<%= @item['item_id'] %>" method="POST" class="text-center">
                            <button type="submit" class="btn btn-link text-dark text-decoration-none p-0 text-center">
                                <img src="/img/icons/heart.svg" class="mb-1" alt="Wishlist">
                                <small>Wishlist</small>
                            </button>
                        </form>
                        <a href="javascript:void(0);" onclick="shareItem()" class="text-dark text-decoration-none text-center">
                            <img src="/img/icons/share.svg" class="mb-1" alt="Wishlist">
                            <small>Share</small>
                        </a>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const price = <%= @item['item_price'].to_i %>;
    const stock = <%= @item['item_stock'].to_i %>;
    const qtyInput = document.getElementById('quantity');
    const totalPrice = document.getElementById('totalPrice');
    const stockWarning = document.getElementById('stockWarning');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    const zeroNumber = document.getElementById('zero');

    function updateTotal() {
        let qty = parseInt(qtyInput.value) || 0;
        if (qty == 0) {
            zeroNumber.style.display = 'block';
            qty = 0; // reset to 0
        } else {
            zeroNumber.style.display = 'none';
        }

        if (qty > stock) qty = stock;
        qtyInput.value = qty;

        totalPrice.innerText = new Intl.NumberFormat('id-ID', 
        { 
            style: 'currency', 
            currency: 'IDR' 
        }).format(price * qty);

        // Show warning when qty == stock 
        stockWarning.style.display = (qty >= stock) ? 'block' : 'none';

        // Disable buttons when at min/max
        decreaseBtn.disabled = (qty <= 1);
        increaseBtn.disabled = (qty >= stock);
    }

    function decreaseQty() {
        qtyInput.value = Math.max(1, parseInt(qtyInput.value) - 1);
        updateTotal();
    }

    function increaseQty() {
        qtyInput.value = Math.min(stock, parseInt(qtyInput.value) + 1);
        updateTotal();
    }

    qtyInput.addEventListener('input', updateTotal);

    // Initialize subtotal on page load 
    updateTotal();

    function shareItem() {
        if (navigator.share) {
            navigator.share({
                title: '<%= @item['item_name'] %>',
                text: 'Lihat produk menarik ini di toko kami!',
                url: window.location.href 
            });
        } else {
            alert("Fitur berbagi tidak didukung di browser ini.");
        }
    }

</script>